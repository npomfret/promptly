<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ask Â· {{PROJECT_NAME}}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script>
    // Pre-load Firebase config to eliminate async delay
    (function() {
      fetch('/config/firebase', { cache: 'no-store' })
        .then(r => r.json())
        .then(config => { window.__firebaseConfig__ = config; })
        .catch(err => console.warn('[AUTH] Failed to pre-load Firebase config:', err));
    })();
  </script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="chat-body" data-require-auth="true">
  <div class="chat-page">
    <div class="chat-container">
      <section class="chat-shell fade-up" data-animate>
        <div class="chat-header">
          <div class="flex gap-md align-center flex-wrap">
            <button onclick="window.history.back()" class="home-icon" title="Go Back">
              <i data-lucide="arrow-left" class="icon"></i>
            </button>
            <a href="/" class="home-icon" title="Home">
              <i data-lucide="home" class="icon"></i>
            </a>
            <div>
              <p class="eyebrow tight">Ask Mode</p>
              <h2>{{PROJECT_NAME}}</h2>
              <p class="text-muted">
                <i data-lucide="git-branch" class="icon"></i> {{PROJECT_BRANCH}}
                <span style="margin-left: 12px; display: inline-flex; align-items: center; gap: 4px;">
                  <code id="project-id-display" style="font-size: 0.85em;">{{PROJECT_ID}}</code>
                  <button onclick="copyProjectId()" class="btn-icon" title="Copy Project ID" style="padding: 0.25rem;">
                    <i data-lucide="copy" class="icon" style="width: 14px; height: 14px;"></i>
                  </button>
                </span>
              </p>
            </div>
          </div>
          <div class="flex flex-column gap-xs align-end text-right">
            <span class="status-badge status-ready">Ready</span>
            <small class="text-muted">Caches synced</small>
          </div>
        </div>

        <div class="tabs">
          <button class="tab-btn active" onclick="switchTab(this, 'test')">
            <i data-lucide="help-circle" class="icon"></i>
            Ask
          </button>
          <button class="tab-btn" onclick="switchTab(this, 'conversation')">
            <i data-lucide="messages-square" class="icon"></i>
            History
          </button>
          <button class="tab-btn" onclick="switchTab(this, 'prompt')">
            <i data-lucide="file-text" class="icon"></i>
            System Prompt
          </button>
          <button class="tab-btn" onclick="switchTab(this, 'api')">
            <i data-lucide="terminal" class="icon"></i>
            API
          </button>
        </div>

        <div id="tab-test" class="tab-content active">
          <div class="chat-input-container">
            <form class="chat-input-form"
                  hx-post="/api/ask-message"
                  hx-target="#messages"
                  hx-swap="innerHTML"
                  hx-on::after-request="if(event.detail.successful) { this.reset(); }">
              <input type="hidden" name="projectId" value="{{PROJECT_ID}}">
              <textarea name="message"
                        placeholder="Ask a question or describe your implementation idea..."
                        required
                        autofocus
                        data-auto-resize></textarea>
              <div class="button-row">
                <button type="submit" class="btn btn-primary">
                  <i data-lucide="send" class="icon"></i>
                  <span class="htmx-indicator">Sending...</span>
                  <span class="htmx-not-indicator">Send</span>
                </button>
              </div>
            </form>
          </div>
          <div class="chat-messages" id="messages">
            <p class="text-muted">Ask questions and get critical analysis with probing questions.</p>
          </div>
        </div>

        <div id="tab-conversation" class="tab-content">
          <div class="chat-messages chat-history" id="conversation-messages"
               hx-get="/api/project-history?projectId={{PROJECT_ID}}&mode=ask"
               hx-trigger="load, promptly-auth"
               data-auth-retry="auto">
            <p class="text-muted">Loading ask history...</p>
          </div>
        </div>

        <div id="tab-prompt" class="tab-content">
          <div class="prompt-viewer">
            <div class="prompt-content markdown-content">{{SYSTEM_PROMPT}}</div>
          </div>
        </div>

        <div id="tab-api" class="tab-content">
          <div class="curl-example">
            <h3><i data-lucide="terminal" class="icon"></i> API Example (curl)</h3>
            <div class="curl-code-container">
              <pre id="curl-code">curl -X POST "{{BASE_URL}}/ask/{{PROJECT_ID}}" \
  -H "Content-Type: application/json" \
  -d '{"message": "How should I implement authentication?"}'</pre>
              <button class="btn btn-secondary btn-small copy-btn" onclick="copyCurl(this)">
                <i data-lucide="copy" class="icon"></i>
                Copy
              </button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/ui.js"></script>
  <script>
    lucide.createIcons();

    document.body.addEventListener('htmx:afterSwap', () => {
      lucide.createIcons();
      const messages = document.getElementById('messages');
      if (messages) {
        messages.scrollTop = messages.scrollHeight;
      }
    });

    // Handle 401 errors by redirecting to login
    document.body.addEventListener('htmx:responseError', (event) => {
      if (event.detail?.xhr?.status === 401) {
        const next = encodeURIComponent(window.location.href);
        window.location.href = `/login?next=${next}`;
      }
    });

    window.addEventListener('load', () => {
      const messages = document.getElementById('messages');
      if (messages) {
        messages.scrollTop = messages.scrollHeight;
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      const textarea = document.querySelector('.chat-input-form textarea');
      if (textarea) {
        textarea.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            const form = e.target.closest('form');
            if (form) {
              form.requestSubmit();
            }
          }
        });
      }
    });

    function switchTab(button, tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      const target = document.getElementById(`tab-${tabName}`);
      if (target) {
        target.classList.add('active');
      }
      (button || event?.currentTarget)?.classList.add('active');
      lucide.createIcons();
    }

    function copyCurl(buttonEl) {
      const curlCode = document.getElementById('curl-code').textContent;
      navigator.clipboard.writeText(curlCode).then(() => {
        const btn = buttonEl || event?.currentTarget;
        const original = btn.innerHTML;
        btn.innerHTML = '<i data-lucide="check" class="icon"></i> Copied!';
        lucide.createIcons();
        setTimeout(() => {
          btn.innerHTML = original;
          lucide.createIcons();
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy to clipboard');
      });
    }

    function copyProjectId() {
      const projectId = document.getElementById('project-id-display').textContent;
      navigator.clipboard.writeText(projectId).then(() => {
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i data-lucide="check" class="icon" style="width: 14px; height: 14px;"></i>';
        lucide.createIcons();
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          lucide.createIcons();
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy project ID:', err);
        alert('Failed to copy project ID to clipboard');
      });
    }
  </script>
</body>
</html>
