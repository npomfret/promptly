<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Promptly · Control Room</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script>
    // Pre-load Firebase config to eliminate async delay
    (function() {
      fetch('/config/firebase', { cache: 'no-store' })
        .then(r => r.json())
        .then(config => { window.__firebaseConfig__ = config; })
        .catch(err => console.warn('[AUTH] Failed to pre-load Firebase config:', err));
    })();
  </script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <main class="page-shell">
    <header class="hero glass-panel fade-up" data-animate>
      <p class="eyebrow">Promptly Control Room</p>
      <h1>Keep projects warm, prompts sharp, and <span>Gemini</span> ready on demand.</h1>
      <p class="lede">Register repositories, hydrate sessions, and monitor cache health from a single cinematic workspace. Add a project and the watcher takes care of the rest.</p>
      <div class="hero-actions">
        <a class="btn btn-secondary" href="/projects">
          <i data-lucide="list" class="icon"></i>
          View Projects
        </a>
        <a class="btn btn-secondary" href="/login" id="login-btn">
          <i data-lucide="log-in" class="icon"></i>
          Login
        </a>
      </div>
    </header>

    <section class="split-grid">
      <article class="glass-panel fade-up" data-animate data-delay="100" id="project-form">
        <div class="section-header">
          <div>
            <p class="eyebrow">Onboard</p>
            <h2>Connect a repository</h2>
          </div>
        </div>
        <form hx-post="/api/projects"
              hx-target="#form-error"
              hx-swap="innerHTML"
              hx-on::before-swap="if(!event.detail.isError) { window.location.href='/projects'; event.preventDefault(); }"
              data-auth-guard="true">
          <div id="form-error" class="form-error-container"></div>
          <div class="form-group">
            <label for="gitUrl">Git URL</label>
            <input type="text" id="gitUrl" name="gitUrl" placeholder="https://github.com/user/repo.git" required>
          </div>
          <div class="form-group">
            <label for="branch">Branch</label>
            <input type="text" id="branch" name="branch" value="main" required>
          </div>
          <div class="form-group">
            <label for="accessToken">Personal Access Token (optional for private repos)</label>
            <input type="password" id="accessToken" name="accessToken" placeholder="ghp_xxxxxxxxxxxx">
            <small>
              Token will be embedded in the Git URL.
              <a href="https://github.com/settings/tokens" target="_blank" rel="noopener">Create token →</a>
            </small>
          </div>
          <div class="button-row align-start">
            <button type="submit" class="btn btn-primary">
              <i data-lucide="plus" class="icon"></i>
              <span class="htmx-indicator">Adding...</span>
              <span class="htmx-not-indicator">Add Project</span>
            </button>
          </div>
        </form>
      </article>

      <article class="glass-panel fade-up" data-animate data-delay="180">
        <div class="section-header">
          <div>
            <p class="eyebrow">Vitals</p>
            <h2>Operational vibes</h2>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <span class="text-muted">Watcher cadence</span>
            <strong>60s</strong>
            <p class="text-muted">Repo updates are scanned every minute to keep cached context fresh.</p>
          </div>
          <div class="stat-card">
            <span class="text-muted">Session Warmth</span>
            <strong>24h</strong>
            <p class="text-muted">Sessions stay toasty for a full day before rotating secrets.</p>
          </div>
          <div class="stat-card">
            <span class="text-muted">Cache TTL</span>
            <strong>3600s</strong>
            <p class="text-muted">Gemini cached content regenerates automatically when stale.</p>
          </div>
        </div>
      </article>
    </section>

    <section class="glass-panel fade-up" data-animate data-delay="260">
      <div class="section-header">
        <div>
          <p class="eyebrow">API</p>
          <h2>Usage examples</h2>
        </div>
      </div>

      <h3 class="subheading mb-md mt-md"><i data-lucide="sparkles" class="icon"></i> Enhance Mode</h3>
      <p class="text-muted mb-md">Get AI-powered enhancements and expansions for your prompts</p>
      <div class="curl-code-container">
        <pre id="curl-enhance">curl -X POST "{{BASE_URL}}/enhance/YOUR_PROJECT_ID" \
  -H "Content-Type: application/json" \
  -d '{"message": "Add dark mode toggle"}'</pre>
        <button class="btn btn-secondary btn-small copy-btn" onclick="copyCurlCode('curl-enhance', this)">
          <i data-lucide="copy" class="icon"></i>
          Copy
        </button>
      </div>

      <h3 class="subheading mb-md mt-lg"><i data-lucide="help-circle" class="icon"></i> Ask Mode</h3>
      <p class="text-muted mb-md">Get critical analysis with probing questions</p>
      <div class="curl-code-container">
        <pre id="curl-ask">curl -X POST "{{BASE_URL}}/ask/YOUR_PROJECT_ID" \
  -H "Content-Type: application/json" \
  -d '{"message": "What are the security implications of this approach?"}'</pre>
        <button class="btn btn-secondary btn-small copy-btn" onclick="copyCurlCode('curl-ask', this)">
          <i data-lucide="copy" class="icon"></i>
          Copy
        </button>
      </div>
    </section>
  </main>

  <script type="module" src="/js/ui.js"></script>
  <script type="module">
    // Conditionally load auth.js only if user might be authenticated
    // This allows logged-in users to use features, but doesn't block unauthenticated visitors
    (async function() {
      // Check if user has cached Firebase auth
      const hasCachedAuth = Object.keys(localStorage).some(key => key.includes('firebase:authUser'));
      if (hasCachedAuth) {
        // Load auth.js for authenticated users
        await import('/js/auth.js');
      }
    })();
  </script>
  <script>
    lucide.createIcons();
    document.body.addEventListener('htmx:afterSwap', () => {
      lucide.createIcons();
    });

    // Hide login button if user is authenticated
    (function() {
      const hasCachedAuth = Object.keys(localStorage).some(key => key.includes('firebase:authUser'));
      if (hasCachedAuth) {
        const loginBtn = document.getElementById('login-btn');
        if (loginBtn) loginBtn.style.display = 'none';
      }
    })();

    document.body.addEventListener('htmx:responseError', (event) => {
      if (!event.detail || !event.detail.xhr) return;
      if (event.detail.xhr.status === 401) {
        const guardedForm = event.detail.elt?.closest('[data-auth-guard=\"true\"]');
        if (guardedForm) {
          const next = encodeURIComponent(window.location.pathname + window.location.search + window.location.hash);
          window.location.href = `/login?next=${next}`;
        }
      }
    });

    function copyCurlCode(elementId, buttonEl) {
      const curlCode = document.getElementById(elementId).textContent;
      navigator.clipboard.writeText(curlCode).then(() => {
        const btn = buttonEl || event?.currentTarget;
        const original = btn.innerHTML;
        btn.innerHTML = '<i data-lucide="check" class="icon"></i> Copied!';
        lucide.createIcons();
        setTimeout(() => {
          btn.innerHTML = original;
          lucide.createIcons();
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy to clipboard');
      });
    }
  </script>
</body>
</html>
