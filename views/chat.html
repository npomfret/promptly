<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - {{PROJECT_NAME}}</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div class="chat-page">
    <div class="chat-container">
      <div class="chat-header">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          <a href="/" class="home-icon" title="Back to Projects">
            <i data-lucide="home" class="icon"></i>
          </a>
          <div>
            <h2>{{PROJECT_NAME}}</h2>
            <p class="text-muted">{{GIT_URL}} • {{PROJECT_BRANCH}} • id:{{PROJECT_ID}}</p>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('test')">
          <i data-lucide="message-circle" class="icon"></i>
          Test
        </button>
        <button class="tab-btn" onclick="switchTab('conversation')">
          <i data-lucide="messages-square" class="icon"></i>
          History
        </button>
        <button class="tab-btn" onclick="switchTab('prompt')">
          <i data-lucide="file-text" class="icon"></i>
          System Prompt
        </button>
        <button class="tab-btn" onclick="switchTab('api')">
          <i data-lucide="terminal" class="icon"></i>
          API
        </button>
      </div>

      <!-- Test Tab (Single Request/Response) -->
      <div id="tab-test" class="tab-content active">
        <div class="chat-input-container">
          <form class="chat-input-form"
                hx-post="/api/chat-message"
                hx-target="#messages"
                hx-swap="innerHTML"
                hx-on::after-request="if(event.detail.successful) { this.reset(); }">
            <input type="hidden" name="projectId" value="{{PROJECT_ID}}">
            <textarea name="message"
                      placeholder="Test your prompt with a question..."
                      required
                      autofocus></textarea>
            <button type="submit" class="btn btn-primary">
              <i data-lucide="send" class="icon"></i>
              <span class="htmx-indicator">Sending...</span>
              <span class="htmx-not-indicator">Send</span>
            </button>
          </form>
        </div>
        <div class="chat-messages" id="messages">
          <p class="text-muted">Test the prompt with a single request.</p>
        </div>
      </div>

      <!-- Conversation Tab (Full History) -->
      <div id="tab-conversation" class="tab-content">
        <div class="chat-messages" id="conversation-messages"
             hx-get="/api/project-history?projectId={{PROJECT_ID}}"
             hx-trigger="load">
          <p class="text-muted">Loading conversation history...</p>
        </div>
      </div>

      <!-- System Prompt Tab -->
      <div id="tab-prompt" class="tab-content">
        <div class="prompt-viewer">
          <pre class="prompt-content">{{SYSTEM_PROMPT}}</pre>
        </div>
      </div>

      <!-- API Tab -->
      <div id="tab-api" class="tab-content">
        <div class="curl-example">
          <h3><i data-lucide="terminal" class="icon"></i> API Example (curl)</h3>
          <div class="curl-code-container">
            <pre id="curl-code">curl -X POST "http://localhost:3000/chat?projectId={{PROJECT_ID}}" \
  -H "Content-Type: application/json" \
  -d '{"message": "What is the project about?"}' \
  -c cookies.txt -b cookies.txt</pre>
            <button class="btn btn-secondary btn-small copy-btn" onclick="copyCurl()">
              <i data-lucide="copy" class="icon"></i>
              Copy
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Re-create icons after HTMX swaps
    document.body.addEventListener('htmx:afterSwap', () => {
      lucide.createIcons();
    });

    // Auto-scroll to bottom on load
    window.addEventListener('load', () => {
      const messages = document.getElementById('messages');
      messages.scrollTop = messages.scrollHeight;
    });

    // Switch tabs
    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });

      // Remove active from all tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // Add active to clicked button
      event.target.closest('.tab-btn').classList.add('active');

      // Re-initialize icons
      lucide.createIcons();
    }

    // Copy curl command to clipboard
    function copyCurl() {
      const curlCode = document.getElementById('curl-code').textContent;
      navigator.clipboard.writeText(curlCode).then(() => {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i data-lucide="check" class="icon"></i> Copied!';
        lucide.createIcons();
        setTimeout(() => {
          btn.innerHTML = originalText;
          lucide.createIcons();
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy to clipboard');
      });
    }
  </script>
</body>
</html>
